<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyo Trip v7.1 | Color Cards Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f7f7f5;
            --text-main: #585858;
            --text-light: #949494;
            --primary-btn: #7a8b99;
            --danger: #d48787;
            --shopping-check: #20bf6b;
            --shop-tag-bg: #e1e8ed;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
            min-height: 100vh;
        }
        .container { width: 100%; max-width: 600px; padding-bottom: 120px; }

        /* åˆ‡æ›æŒ‰éˆ• */
        .nav-switch { display: flex; background: #e6e6e6; border-radius: 30px; padding: 5px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 25px; font-weight: bold; color: #999; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; }
        .subtitle { font-size: 0.8rem; color: var(--text-light); }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* å¤©æ•¸ Tabs */
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: #e6e6e6; color: #999; border: none; padding: 8px 16px; border-radius: 20px; white-space: nowrap; cursor: pointer; }
        .tab-btn.active { background: var(--primary-btn); color: white; }

        /* è³‡è¨Šå¡ç‰‡ */
        .day-info-card {
            background: white; border-radius: 20px; padding: 15px 20px; margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 10px;
        }
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        
        .date-wrapper { display: flex; align-items: center; gap: 8px; }
        .input-date { border: none; background: #f0f2f4; padding: 5px 10px; border-radius: 8px; font-family: 'Playfair Display', serif; font-size: 1rem; width: 140px; }
        .weekday-badge { font-size: 0.8rem; background: #d8b8b8; color: white; padding: 4px 8px; border-radius: 6px; }

        .weather-control { display: flex; gap: 8px; align-items: center; }
        .btn-fetch-weather { background: #f0f2f4; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; }

        .list-container { list-style: none; padding: 0; margin: 0; }
        
        /* è¡Œç¨‹å¡ç‰‡ (å½©è‰²ç‰ˆ) */
        .trip-item {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); position: relative; 
            border-left: 6px solid #ddd; transition: transform 0.2s;
        }
        .trip-item input, .trip-item select { background: rgba(255,255,255,0.5); border-radius: 4px; }
        .note-box { background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 8px; margin-top: 5px; }

        /* è³¼ç‰©æ¸…å–® */
        .shopping-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-sort { background: var(--shop-tag-bg); color: var(--text-main); border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; }

        .shop-item {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); display: flex; align-items: flex-start; gap: 10px;
            position: relative; transition: opacity 0.3s;
        }
        .shop-checkbox {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-top: 2px;
        }
        .shop-checkbox.checked { background: var(--shopping-check); border-color: var(--shopping-check); }
        .shop-content { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        
        .shop-tag-wrapper { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .input-shop { background: var(--shop-tag-bg); border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.85rem; color: #555; width: 100px; font-weight: 500; }
        .shop-name { width: 100%; border: none; font-size: 1.05rem; font-weight: 500; color: var(--text-main); }
        .shop-meta { display: flex; gap: 8px; font-size: 0.9rem; color: #999; align-items: center; }
        .shop-item.completed { opacity: 0.5; }
        .shop-item.completed .shop-name { text-decoration: line-through; }

        /* è¼¸å…¥æ¡†é€šç”¨ */
        input, select { color: var(--text-main); font-family: inherit; border: 1px solid transparent; }
        input:focus { border-bottom: 1px solid var(--primary-btn); }
        .input-cost-sm { width: 60px; border: none; border-bottom: 1px dashed #999; text-align: right; }
        
        /* åº•éƒ¨æŒ‰éˆ• */
        .bottom-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; gap: 15px; z-index: 100;
        }
        .action-btn { background: var(--primary-btn); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: 500; cursor: pointer; }

        /* è¡Œç¨‹ç´°ç¯€ */
        .item-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .input-time { border: none; font-family: 'Playfair Display'; font-weight: bold; width: 60px; font-size: 1.1rem; }
        .btn-delete { position: absolute; top: 10px; right: 10px; border: none; background: none; color: #999; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .btn-delete:hover { color: var(--danger); }
        .input-location { width: 100%; border: none; font-weight: 500; font-size: 1rem; background: transparent !important; }
        .btn-map { background: rgba(255,255,255,0.8); border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; color: var(--primary-btn); display: flex; align-items: center; justify-content: center; }

        .total-display { text-align: center; color: var(--text-light); font-size: 0.8rem; margin-top: 30px; }
        .total-display b { color: var(--text-main); font-size: 1rem; margin: 0 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-switch">
            <button class="nav-btn active" onclick="switchView('itinerary')">ğŸ“… è¡Œç¨‹è¡¨</button>
            <button class="nav-btn" onclick="switchView('shopping')">ğŸ›ï¸ è³¼ç‰©æ¸…å–®</button>
        </div>

        <header>
            <h1>Tokyo Trip</h1>
            <div class="subtitle">Itinerary & Shopping List</div>
        </header>

        <div id="view-itinerary" class="view-section active">
            <div class="tabs" id="dayTabs"></div>

            <div class="day-info-card">
                <div class="info-row">
                    <div class="date-wrapper">
                        <input type="date" id="dateInput" class="input-date" onchange="updateDate()">
                        <span id="weekdayBadge" class="weekday-badge">---</span>
                    </div>
                    <button class="btn-fetch-weather" onclick="fetchWeather()" title="æ›´æ–°å¤©æ°£">ğŸ”„</button>
                </div>
                <hr style="border:0; border-top:1px solid #f9f9f9; width:100%; margin: 8px 0;">
                <div class="info-row">
                    <div class="weather-control">
                        <select id="weatherSelect" style="border:none; background:transparent; font-size:1.5rem;" onchange="updateWeather()">
                            <option value="â˜€ï¸">â˜€ï¸</option><option value="â˜ï¸">â˜ï¸</option>
                            <option value="ğŸŒ§ï¸">ğŸŒ§ï¸</option><option value="â›ˆï¸">â›ˆï¸</option><option value="ğŸŒ¨ï¸">ğŸŒ¨ï¸</option>
                        </select>
                        <input type="text" id="tempInput" style="width:60px; border:none; border-bottom:1px solid #eee; text-align:center;" placeholder="Temp" onchange="updateWeather()">
                    </div>
                    <span style="font-size:0.8rem; color:#aaa"><span id="itemCount">0</span> spots</span>
                </div>
            </div>

            <ul id="tripList" class="list-container"></ul>
        </div>

        <div id="view-shopping" class="view-section">
            <div class="day-info-card" style="align-items: center; justify-content: center; background:#fdfdfd;">
                <div style="text-align:center;">
                    <div style="font-size:0.8rem; color:#999; letter-spacing:1px;">SHOPPING SPENT</div>
                    <div style="font-size:1.5rem; font-family:'Playfair Display'; margin-top:5px; color:var(--text-main);">
                        Â¥ <span id="shopTotal">0</span>
                    </div>
                </div>
            </div>

            <div class="shopping-header">
                <span style="font-size:0.9rem; font-weight:bold; color:#aaa;">ITEMS</span>
                <button class="btn-sort" onclick="sortShopping()">ğŸ“‚ æŒ‰å•†åº—åˆ†é¡</button>
            </div>

            <ul id="shopList" class="list-container"></ul>
        </div>

        <div class="total-display">
            TOTAL ESTIMATED<br>
            Â¥<b id="totalJpy">0</b> Â |Â  NT$<b id="totalTwd">0</b>
        </div>
    </div>

    <div class="bottom-bar" id="bottomBar"></div>

    <script>
        // === 1. è¨­å®š & è³‡æ–™ ===
        const categoryStyles = {
            'transport':   { border: '#8fa3ad', bg: '#f0f4f6' }, // è—
            'sightseeing': { border: '#a7bfa0', bg: '#f1f6f0' }, // ç¶ 
            'food':        { border: '#e0cc9e', bg: '#fbf8f1' }, // é»ƒ
            'shopping':    { border: '#d8b8b8', bg: '#f9f4f4' }, // ç²‰
            'hotel':       { border: '#bfaec2', bg: '#f7f4f8' }, // ç´«
            'other':       { border: '#d1d1d1', bg: '#f9f9f9' }  // ç°
        };

        const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        let appData = {
            view: 'itinerary',
            currentDayIdx: 0,
            days: [{ date: "", weather: "â˜€ï¸", temp: "", items: [{ id: 1, time: "10:00", category: "transport", location: "æˆç”°æ©Ÿå ´", cost: 0, currency: "JPY", note: "" }] }],
            shoppingList: [ { id: 101, name: "åˆåˆ©ä»–å‘½", shop: "è—¥å¦åº—", cost: 5500, bought: false, note: "å¹«åª½åª½è²·" } ]
        };

        // === 2. åˆå§‹åŒ– ===
        window.onload = () => {
            console.log("App Starting...");
            const saved = localStorage.getItem('tokyo_trip_v7');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                    if(!appData.shoppingList) appData.shoppingList = [];
                } catch(e) { console.error("Data Load Error", e); }
            }
            renderAll();
        };

        // === 3. è¦–åœ–åˆ‡æ› ===
        function switchView(viewName) {
            appData.view = viewName;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`.nav-btn[onclick="switchView('${viewName}')"]`)[0].classList.add('active');
            document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            renderAll();
        }

        function renderAll() {
            if(appData.view === 'itinerary') {
                renderTabs();
                renderItinerary();
                renderBottomBarItinerary();
            } else {
                renderShopping();
                renderBottomBarShopping();
            }
            calcTotal();
            save();
        }

        // === 4. è¡Œç¨‹è¡¨æ¸²æŸ“ ===
        function renderTabs() {
            const c = document.getElementById('dayTabs');
            c.innerHTML = '';
            appData.days.forEach((d, i) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${i === appData.currentDayIdx ? 'active' : ''}`;
                btn.innerText = `Day ${i+1}`;
                btn.onclick = () => { appData.currentDayIdx = i; renderAll(); };
                c.appendChild(btn);
            });
        }

        function renderItinerary() {
            const day = appData.days[appData.currentDayIdx];
            document.getElementById('dateInput').value = day.date;
            document.getElementById('weatherSelect').value = day.weather;
            document.getElementById('tempInput').value = day.temp;
            document.getElementById('itemCount').innerText = day.items.length;
            
            const badge = document.getElementById('weekdayBadge');
            if(day.date) {
                const d = new Date(day.date).getDay();
                badge.innerText = weekDays[d];
                badge.style.background = (d===0||d===6) ? '#d8b8b8' : '#ccc';
            } else {
                badge.innerText = "---";
                badge.style.background = '#ccc';
            }

            const list = document.getElementById('tripList');
            list.innerHTML = '';
            day.items.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'trip-item';
                
                // å¥—ç”¨å½©è‰²æ¨£å¼
                const style = categoryStyles[item.category] || categoryStyles['other'];
                li.style.borderLeftColor = style.border;
                li.style.backgroundColor = style.bg;

                li.innerHTML = `
                    <button class="btn-delete" onclick="delItem(${idx})">Ã—</button>
                    <div class="item-header">
                        <input type="time" class="input-time" value="${item.time}" onchange="updItem(${idx}, 'time', this.value)">
                        <select onchange="updItem(${idx}, 'category', this.value)" style="font-size:0.8rem; border:none; background:rgba(255,255,255,0.5); padding:2px 5px; border-radius:4px;">
                            <option value="transport" ${item.category=='transport'?'selected':''}>äº¤é€š</option>
                            <option value="sightseeing" ${item.category=='sightseeing'?'selected':''}>æ™¯é»</option>
                            <option value="food" ${item.category=='food'?'selected':''}>ç¾é£Ÿ</option>
                            <option value="shopping" ${item.category=='shopping'?'selected':''}>é€›è¡—</option>
                            <option value="hotel" ${item.category=='hotel'?'selected':''}>é£¯åº—</option>
                            <option value="other" ${item.category=='other'?'selected':''}>å…¶ä»–</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:8px;">
                        <input type="text" class="input-location" value="${item.location}" placeholder="åœ°é»åç¨±" onchange="updItem(${idx}, 'location', this.value)">
                        <button class="btn-map" onclick="openMap('${item.location}')">ğŸ“</button>
                    </div>
                    <div class="note-box" style="display:flex; gap:5px; align-items:center;">
                        <span style="font-size:0.8rem;">Â¥</span>
                        <input type="number" class="input-cost-sm" value="${item.cost}" placeholder="0" onchange="updItem(${idx}, 'cost', this.value)">
                        <select onchange="updItem(${idx}, 'currency', this.value)" style="border:none; background:transparent; font-size:0.7rem;">
                            <option value="JPY" ${item.currency=='JPY'?'selected':''}>JPY</option>
                            <option value="TWD" ${item.currency=='TWD'?'selected':''}>TWD</option>
                        </select>
                        <input type="text" value="${item.note}" placeholder="å‚™è¨»..." style="flex:1; border:none; background:transparent; font-size:0.9rem;" onchange="updItem(${idx}, 'note', this.value)">
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // === 5. è³¼ç‰©æ¸…å–®æ¸²æŸ“ ===
        function renderShopping() {
            const list = document.getElementById('shopList');
            list.innerHTML = '';
            let shopTotal = 0;
            appData.shoppingList.forEach((item, idx) => {
                if(item.bought) shopTotal += Number(item.cost);
                const li = document.createElement('li');
                li.className = `shop-item ${item.bought ? 'completed' : ''}`;
                li.innerHTML = `
                    <div class="shop-checkbox ${item.bought?'checked':''}" onclick="toggleShop(${idx})">âœ“</div>
                    <div class="shop-content">
                        <div class="shop-tag-wrapper">
                             <input type="text" class="input-shop" value="${item.shop || ''}" placeholder="å•†åº—" onchange="updShop(${idx}, 'shop', this.value)">
                             <input type="text" class="shop-name" value="${item.name}" placeholder="å•†å“åç¨±" onchange="updShop(${idx}, 'name', this.value)">
                        </div>
                        <div class="shop-meta">
                            <span>Â¥</span>
                            <input type="number" class="input-cost-sm" value="${item.cost}" placeholder="é ç®—" onchange="updShop(${idx}, 'cost', this.value)">
                            <span style="color:#eee">|</span>
                            <input type="text" value="${item.note}" placeholder="å‚™è¨»" style="border:none; border-bottom:1px dashed #eee; flex:1; font-size:0.9rem;" onchange="updShop(${idx}, 'note', this.value)">
                        </div>
                    </div>
                    <button class="btn-delete" style="position:static; color:#ddd;" onclick="delShop(${idx})">Ã—</button>
                `;
                list.appendChild(li);
            });
            document.getElementById('shopTotal').innerText = shopTotal.toLocaleString();
        }

        // === 6. åŠŸèƒ½å‡½å¼ ===
        function sortShopping() {
            appData.shoppingList.sort((a, b) => {
                if(a.bought !== b.bought) return a.bought ? 1 : -1;
                if(!a.shop) return 1; if(!b.shop) return -1;
                return a.shop.localeCompare(b.shop, "zh-Hant");
            });
            renderShopping();
            save();
            alert('è³¼ç‰©æ¸…å–®å·²ä¾å•†åº—åˆ†é¡æ’åºï¼');
        }

        async function fetchWeather() {
            const day = appData.days[appData.currentDayIdx];
            if(!day.date) { alert('è«‹å…ˆè¨­å®šæ—¥æœŸ'); return; }
            const btn = document.querySelector('.btn-fetch-weather');
            btn.innerHTML = 'â³';
            const lat = 35.6895; const lon = 139.6917;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max&timezone=Asia%2FTokyo&start_date=${day.date}&end_date=${day.date}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(data.daily && data.daily.weathercode) {
                    const code = data.daily.weathercode[0];
                    let icon = "â˜€ï¸";
                    if(code >= 1 && code <= 3) icon = "â˜ï¸";
                    if(code >= 45 && code <= 48) icon = "ğŸŒ«ï¸";
                    if(code >= 51 && code <= 67) icon = "ğŸŒ§ï¸";
                    if(code >= 71 && code <= 77) icon = "ğŸŒ¨ï¸";
                    if(code >= 95) icon = "â›ˆï¸";
                    day.weather = icon;
                    day.temp = `${data.daily.temperature_2m_max[0]}Â°C`;
                    renderAll();
                    alert(`æ›´æ–°æˆåŠŸ: ${icon} ${day.temp}`);
                } else { alert('ç›®å‰æŸ¥ç„¡æ­¤æ—¥æœŸçš„é å ±è³‡æ–™(åƒ…é™14å¤©å…§)'); }
            } catch(e) { alert('é€£ç·šå¤±æ•—'); } 
            finally { btn.innerHTML = 'ğŸ”„'; }
        }

        // åº•éƒ¨æŒ‰éˆ•æ¸²æŸ“
        function renderBottomBarItinerary() {
            document.getElementById('bottomBar').innerHTML = `
                <button class="action-btn" onclick="addItem()">+ Add Item</button>
                <button class="action-btn" style="background:white; color:#999; border:1px solid #ddd;" onclick="addDay()">+ Day</button>
            `;
        }
        function renderBottomBarShopping() {
            document.getElementById('bottomBar').innerHTML = `
                <button class="action-btn" style="background:var(--shopping-check);" onclick="addShop()">+ Add Product</button>
            `;
        }

        // è³‡æ–™å¢åˆªæ”¹
        function addItem() { appData.days[appData.currentDayIdx].items.push({id:Date.now(), time:"10:00", category:"other", location:"", cost:0, currency:"JPY", note:""}); renderAll(); }
        function updItem(i, k, v) { appData.days[appData.currentDayIdx].items[i][k] = v; renderAll(); }
        function delItem(i) { if(confirm('åˆªé™¤?')) { appData.days[appData.currentDayIdx].items.splice(i,1); renderAll(); } }
        
        function addDay() { appData.days.push({date:"", weather:"â˜€ï¸", temp:"", items:[]}); appData.currentDayIdx = appData.days.length-1; renderAll(); }
        function updateDate() { appData.days[appData.currentDayIdx].date = document.getElementById('dateInput').value; renderAll(); }
        function updateWeather() { appData.days[appData.currentDayIdx].weather = document.getElementById('weatherSelect').value; appData.days[appData.currentDayIdx].temp = document.getElementById('tempInput').value; save(); }

        function addShop() { appData.shoppingList.push({id:Date.now(), name:"", shop:"", cost:0, bought:false, note:""}); renderAll(); }
        function toggleShop(i) { appData.shoppingList[i].bought = !appData.shoppingList[i].bought; renderAll(); }
        function updShop(i, k, v) { appData.shoppingList[i][k] = v; renderAll(); }
        function delShop(i) { if(confirm('åˆªé™¤å•†å“?')) { appData.shoppingList.splice(i,1); renderAll(); } }

        function calcTotal() {
            let jpy = 0; let twd = 0;
            appData.days.forEach(d => d.items.forEach(i => {
                if(i.currency === 'JPY') jpy += Number(i.cost);
                if(i.currency === 'TWD') twd += Number(i.cost);
            }));
            appData.shoppingList.forEach(s => { if(s.bought) jpy += Number(s.cost); });
            document.getElementById('totalJpy').innerText = jpy.toLocaleString();
            document.getElementById('totalTwd').innerText = twd.toLocaleString();
        }

        // åœ°åœ–åŠŸèƒ½ä¿®æ­£
        function openMap(loc) { 
            if(loc) {
                // ä½¿ç”¨æ¨™æº– Google Maps Search URL
                const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(loc);
                window.open(url, '_blank');
            }
        }
        
        function save() { localStorage.setItem('tokyo_trip_v7', JSON.stringify(appData)); }
    </script>
</body>
</html>