<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyo Trip v10.1 | Time Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Noto+Sans+TC:wght@400;500;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-main: #4a4a4a;
            --text-light: #888;
            --primary-btn: #7a8b99;
            --danger: #d48787;
            --shopping-check: #20bf6b;
            --shop-tag-bg: #e1e8ed;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
            min-height: 100vh;
            /* ËÉåÊôØÂúñ */
            background-image: 
                linear-gradient(to bottom, rgba(247, 247, 245, 0.85), rgba(247, 247, 245, 0.95)),
                url('https://unsplash.com/photos/selective-focus-photography-of-pink-petaled-flower-eriuKJwcdjI');
            background-size: cover; background-position: center; background-attachment: fixed;
        }

        .container { width: 100%; max-width: 600px; padding-bottom: 120px; }

        /* Â∞éËà™ */
        .nav-switch { display: flex; background: rgba(230, 230, 230, 0.8); backdrop-filter: blur(5px); border-radius: 30px; padding: 5px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 25px; font-weight: bold; color: #999; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 0; text-shadow: 0 2px 10px rgba(255,255,255,0.5); }
        .subtitle { font-size: 0.8rem; color: var(--text-light); }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .tab-btn { background: rgba(230, 230, 230, 0.8); color: #999; border: none; padding: 8px 16px; border-radius: 20px; white-space: nowrap; cursor: pointer; backdrop-filter: blur(5px); }
        .tab-btn.active { background: var(--primary-btn); color: white; }

        /* === Ë≥áË®äÂç°Áâá === */
        .day-info-card {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px 20px; margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); backdrop-filter: blur(10px);
            display: flex; flex-direction: row; justify-content: space-between; align-items: center;
        }

        /* Â∑¶ÂÅ¥ÔºöÊó•Êúü */
        .header-left { display: flex; flex-direction: column; gap: 2px; }
        .date-input-group { display: flex; align-items: baseline; gap: 5px; }
        .input-date { 
            border: none; background: transparent; font-family: 'Oswald', sans-serif; 
            font-size: 1.5rem; font-weight: 600; color: #2c3e50; width: 155px;
        }
        .weekday-badge { 
            font-family: 'Noto Sans TC', cursive; font-size: 1.2rem; color: #aaa; margin-left: 5px;
        }

        /* Âè≥ÂÅ¥ÔºöÊâãÁπ™Â§©Ê∞£ */
        .header-right { display: flex; align-items: center; gap: 10px; }
        .weather-icon-wrapper {
            width: 50px; height: 50px; position: relative; cursor: pointer;
            transition: transform 0.2s;
        }
        .weather-icon-wrapper:active { transform: scale(0.9); }
        .weather-svg { width: 100%; height: 100%; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1)); }
        
        .temp-input {
            width: 50px; border: none; background: transparent; 
            font-family: 'Noto Sans TC', cursive; font-size: 1.4rem; color: #666; text-align: right;
        }
        .weather-select-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }

        .list-container { list-style: none; padding: 0; margin: 0; }

        /* === Ë°åÁ®ãÂç°Áâá === */
        .trip-item {
            background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; 
            border-left: 6px solid #ddd; transition: transform 0.2s; backdrop-filter: blur(5px);
        }
        
        /* ÊôÇÈñì + Âú∞Èªû */
        .row-main { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        
        /* === ÊôÇÈñìÊ¨Ñ‰ΩçÂØ¨Â∫¶‰øÆÊ≠£ === */
        .input-time {
            font-family: 'Oswald', sans-serif; font-size: 1.5rem; font-weight: 500;
            color: var(--text-main);
            width: 120px; /* ÂéüÊú¨60px -> ÊîπÁÇ∫85px */
            border: none; background: transparent; padding: 0; margin-right: 5px;
        }
        .input-time::-webkit-datetime-edit-ampm-field { display: none; }
        
        .input-location {
            flex-grow: 1; font-size: 1.3rem; font-weight: 700; color: #2c3e50;
            border: none; background: transparent; border-bottom: 1px dashed transparent;
        }
        .input-location:focus { border-bottom-color: var(--primary-btn); }
        .btn-delete { color: #e0e0e0; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 0 0 10px; }
        .btn-delete:hover { color: var(--danger); }

        /* Á¨¨‰∫åË°å */
        .row-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .select-category {
            font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; border: none;
            background: rgba(0,0,0,0.05); color: #666; font-weight: 500; cursor: pointer;
        }
        .btn-map {
            background: none; border: 1px solid #eee; border-radius: 50%; 
            width: 28px; height: 28px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .note-wrapper {
            flex-grow: 1; display: flex; align-items: center; background: rgba(0,0,0,0.03); 
            border-radius: 8px; padding: 4px 10px; gap: 5px;
        }
        .input-note { width: 100%; border: none; background: transparent; font-size: 0.9rem; color: #666; }
        .cost-group { display: flex; align-items: center; gap: 2px; }
        .input-cost-sm { width: 50px; border: none; background: transparent; text-align: right; font-size: 0.9rem; font-weight: 500; }
        .select-currency-sm { border: none; background: transparent; font-size: 0.7rem; color: #999; }

        /* Ë≥ºÁâ©Ê∏ÖÂñÆ */
        .shopping-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-sort { background: var(--shop-tag-bg); color: var(--text-main); border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; }
        .shop-item {
            background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; align-items: flex-start; gap: 10px;
            position: relative; transition: opacity 0.3s; backdrop-filter: blur(5px);
        }
        .shop-checkbox { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; margin-top: 2px; }
        .shop-checkbox.checked { background: var(--shopping-check); border-color: var(--shopping-check); }
        .shop-content { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .shop-tag-wrapper { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .input-shop { background: var(--shop-tag-bg); border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.85rem; color: #555; width: 100px; font-weight: 500; }
        .shop-name { width: 100%; border: none; font-size: 1.05rem; font-weight: 500; color: var(--text-main); }
        .shop-meta { display: flex; gap: 8px; font-size: 0.9rem; color: #999; align-items: center; }
        .shop-item.completed { opacity: 0.5; }
        .shop-item.completed .shop-name { text-decoration: line-through; }

        /* Â∫ïÈÉ®ÊåâÈàï */
        .bottom-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px);
            padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; gap: 15px; z-index: 100; border: 1px solid rgba(255,255,255,0.3);
        }
        .action-btn { background: var(--primary-btn); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: 500; cursor: pointer; box-shadow: 0 5px 15px rgba(122, 139, 153, 0.3); }
        
        /* Á∏ΩË®à */
        .total-display { text-align: center; color: var(--text-light); font-size: 0.8rem; margin-top: 30px; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        .total-display b { color: var(--text-main); font-size: 1rem; margin: 0 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-switch">
            <button class="nav-btn active" onclick="switchView('itinerary')">üìÖ Ë°åÁ®ãË°®</button>
            <button class="nav-btn" onclick="switchView('shopping')">üõçÔ∏è Ë≥ºÁâ©Ê∏ÖÂñÆ</button>
        </div>

        <header>
            <h1>Tokyo Trip</h1>
            <div class="subtitle">Itinerary & Shopping List</div>
        </header>

        <div id="view-itinerary" class="view-section active">
            <div class="tabs" id="dayTabs"></div>

            <div class="day-info-card">
                <div class="header-left">
                    <div class="date-input-group">
                        <input type="date" id="dateInput" class="input-date" onchange="updateDate()">
                        <button onclick="fetchWeather()" style="border:none; bg:transparent; font-size:0.8rem; cursor:pointer; color:#aaa;" title="Êõ¥Êñ∞Â§©Ê∞£">‚Üª</button>
                    </div>
                    <div id="weekdayBadge" class="weekday-badge">Sunday</div>
                </div>

                <div class="header-right">
                    <div class="weather-icon-wrapper" id="weatherIconContainer">
                        <div id="currentWeatherIcon"></div>
                        <select id="weatherSelect" class="weather-select-hidden" onchange="updateWeather()">
                            <option value="sunny">Êô¥Â§©</option>
                            <option value="cloudy">Â§öÈõ≤</option>
                            <option value="rainy">‰∏ãÈõ®</option>
                            <option value="storm">Èõ∑Èõ®</option>
                            <option value="snow">‰∏ãÈõ™</option>
                        </select>
                    </div>
                    <input type="text" id="tempInput" class="temp-input" placeholder="20¬∞" onchange="updateWeather()">
                </div>
            </div>

            <ul id="tripList" class="list-container"></ul>
        </div>

        <div id="view-shopping" class="view-section">
            <div class="day-info-card" style="align-items: center; justify-content: center; background:rgba(253,253,253,0.9);">
                <div style="text-align:center;">
                    <div style="font-size:0.8rem; color:#999; letter-spacing:1px;">SHOPPING SPENT</div>
                    <div style="font-size:1.5rem; font-family:'Playfair Display'; margin-top:5px; color:var(--text-main);">
                        ¬• <span id="shopTotal">0</span>
                    </div>
                </div>
            </div>
            <div class="shopping-header">
                <span style="font-size:0.9rem; font-weight:bold; color:#aaa; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">ITEMS</span>
                <button class="btn-sort" onclick="sortShopping()">üìÇ ÊåâÂïÜÂ∫óÂàÜÈ°û</button>
            </div>
            <ul id="shopList" class="list-container"></ul>
        </div>

        <div class="total-display">
            TOTAL ESTIMATED<br>
            ¬•<b id="totalJpy">0</b> ¬†|¬† NT$<b id="totalTwd">0</b>
        </div>
    </div>

    <div class="bottom-bar" id="bottomBar"></div>

    <script>
        // ÊâãÁπ™È¢®Ê†º SVG
        const svgIcons = {
            'sunny': `<svg viewBox="0 0 100 100" fill="none" stroke="#f39c12" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><circle cx="50" cy="50" r="20" /><path d="M50 15v-10M50 95v-10M15 50H5M95 50H85M25 25L18 18M82 82l-7-7M25 75l-7 7M82 18l-7 7" /></svg>`,
            'cloudy': `<svg viewBox="0 0 100 100" fill="none" stroke="#95a5a6" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M25 60a15 15 0 0 1 0-30 18 18 0 0 1 35-10 18 18 0 0 1 15 35h-50z" /></svg>`,
            'rainy': `<svg viewBox="0 0 100 100" fill="none" stroke="#3498db" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M25 50a15 15 0 0 1 0-30 18 18 0 0 1 35-10 18 18 0 0 1 15 35h-50z" stroke="#95a5a6"/><path d="M35 65l-5 15M50 65l-5 15M65 65l-5 15" /></svg>`,
            'storm': `<svg viewBox="0 0 100 100" fill="none" stroke="#f1c40f" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M25 50a15 15 0 0 1 0-30 18 18 0 0 1 35-10 18 18 0 0 1 15 35h-50z" stroke="#555"/><path d="M45 60l-10 15h10l-5 15" /></svg>`,
            'snow': `<svg viewBox="0 0 100 100" fill="none" stroke="#a29bfe" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M50 20v60M20 50h60M28 28l44 44M28 72l44-44" /></svg>`
        };

        const categoryStyles = {
            'transport':   { border: '#8fa3ad', bg: '#f0f4f6' }, 
            'sightseeing': { border: '#c0392b', bg: '#fdedec' }, 
            'food':        { border: '#e0cc9e', bg: '#fbf8f1' }, 
            'shopping':    { border: '#d8b8b8', bg: '#f9f4f4' }, 
            'hotel':       { border: '#8d6e63', bg: '#efebe9' }, 
            'other':       { border: '#d1d1d1', bg: '#f9f9f9' }
        };

        const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        let appData = {
            view: 'itinerary',
            currentDayIdx: 0,
            days: [{ date: "", weather: "sunny", temp: "", items: [{ id: 1, time: "10:00", category: "transport", location: "ÊàêÁî∞Ê©üÂ†¥", cost: 0, currency: "JPY", note: "" }] }],
            shoppingList: [ { id: 101, name: "ÂêàÂà©‰ªñÂëΩ", shop: "Ëó•Â¶ùÂ∫ó", cost: 5500, bought: false, note: "Âπ´Â™ΩÂ™ΩË≤∑" } ]
        };

        window.onload = () => {
            const saved = localStorage.getItem('tokyo_trip_v7');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                    if(!appData.shoppingList) appData.shoppingList = [];
                } catch(e) { console.error("Error", e); }
            }
            renderAll();
        };

        function switchView(viewName) {
            appData.view = viewName;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`.nav-btn[onclick="switchView('${viewName}')"]`)[0].classList.add('active');
            document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            renderAll();
        }

        function renderAll() {
            if(appData.view === 'itinerary') {
                renderTabs();
                renderItinerary();
                renderBottomBarItinerary();
            } else {
                renderShopping();
                renderBottomBarShopping();
            }
            calcTotal();
            save();
        }

        function renderTabs() {
            const c = document.getElementById('dayTabs');
            c.innerHTML = '';
            appData.days.forEach((d, i) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${i === appData.currentDayIdx ? 'active' : ''}`;
                btn.innerText = `Day ${i+1}`;
                btn.onclick = () => { appData.currentDayIdx = i; renderAll(); };
                c.appendChild(btn);
            });
        }

        function renderItinerary() {
            const day = appData.days[appData.currentDayIdx];
            document.getElementById('dateInput').value = day.date;
            const badge = document.getElementById('weekdayBadge');
            if(day.date) {
                const d = new Date(day.date).getDay();
                badge.innerText = weekDays[d];
                badge.style.color = (d===0||d===6) ? '#d48787' : '#aaa';
            } else {
                badge.innerText = "Date?";
            }

            document.getElementById('weatherSelect').value = day.weather || 'sunny';
            document.getElementById('tempInput').value = day.temp;
            const weatherType = day.weather || 'sunny';
            document.getElementById('currentWeatherIcon').innerHTML = svgIcons[weatherType] || svgIcons['sunny'];

            const list = document.getElementById('tripList');
            list.innerHTML = '';
            day.items.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'trip-item';
                const style = categoryStyles[item.category] || categoryStyles['other'];
                li.style.borderLeftColor = style.border;
                li.style.backgroundColor = style.bg;

                li.innerHTML = `
                    <div class="row-main">
                        <input type="time" class="input-time" value="${item.time}" onchange="updItem(${idx}, 'time', this.value)">
                        <input type="text" class="input-location" value="${item.location}" placeholder="Âú∞ÈªûÂêçÁ®±" onchange="updItem(${idx}, 'location', this.value)">
                        <button class="btn-delete" onclick="delItem(${idx})">√ó</button>
                    </div>

                    <div class="row-meta">
                        <select class="select-category" onchange="updItem(${idx}, 'category', this.value)">
                            <option value="transport" ${item.category=='transport'?'selected':''}>‰∫§ÈÄö</option>
                            <option value="sightseeing" ${item.category=='sightseeing'?'selected':''}>ÊôØÈªû</option>
                            <option value="food" ${item.category=='food'?'selected':''}>ÁæéÈ£ü</option>
                            <option value="shopping" ${item.category=='shopping'?'selected':''}>ÈÄõË°ó</option>
                            <option value="hotel" ${item.category=='hotel'?'selected':''}>È£ØÂ∫ó</option>
                            <option value="other" ${item.category=='other'?'selected':''}>ÂÖ∂‰ªñ</option>
                        </select>
                        <button class="btn-map" onclick="openMap('${item.location}')">üìç</button>
                        <div class="note-wrapper">
                            <input type="text" class="input-note" value="${item.note}" placeholder="ÂÇôË®ª..." onchange="updItem(${idx}, 'note', this.value)">
                            <div class="cost-group">
                                <span style="font-size:0.8rem; color:#aaa;">¬•</span>
                                <input type="number" class="input-cost-sm" value="${item.cost}" placeholder="0" onchange="updItem(${idx}, 'cost', this.value)">
                                <select class="select-currency-sm" onchange="updItem(${idx}, 'currency', this.value)">
                                    <option value="JPY" ${item.currency=='JPY'?'selected':''}>JPY</option>
                                    <option value="TWD" ${item.currency=='TWD'?'selected':''}>TWD</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderShopping() {
            const list = document.getElementById('shopList');
            list.innerHTML = '';
            let shopTotal = 0;
            appData.shoppingList.forEach((item, idx) => {
                if(item.bought) shopTotal += Number(item.cost);
                const li = document.createElement('li');
                li.className = `shop-item ${item.bought ? 'completed' : ''}`;
                li.innerHTML = `
                    <div class="shop-checkbox ${item.bought?'checked':''}" onclick="toggleShop(${idx})">‚úì</div>
                    <div class="shop-content">
                        <div class="shop-tag-wrapper">
                             <input type="text" class="input-shop" value="${item.shop || ''}" placeholder="ÂïÜÂ∫ó" onchange="updShop(${idx}, 'shop', this.value)">
                             <input type="text" class="shop-name" value="${item.name}" placeholder="ÂïÜÂìÅÂêçÁ®±" onchange="updShop(${idx}, 'name', this.value)">
                        </div>
                        <div class="shop-meta">
                            <span>¬•</span>
                            <input type="number" class="input-cost-sm" value="${item.cost}" placeholder="È†êÁÆó" onchange="updShop(${idx}, 'cost', this.value)">
                            <span style="color:#eee">|</span>
                            <input type="text" value="${item.note}" placeholder="ÂÇôË®ª" style="border:none; border-bottom:1px dashed #eee; flex:1; font-size:0.9rem;" onchange="updShop(${idx}, 'note', this.value)">
                        </div>
                    </div>
                    <button class="btn-delete" style="position:static; color:#ddd;" onclick="delShop(${idx})">√ó</button>
                `;
                list.appendChild(li);
            });
            document.getElementById('shopTotal').innerText = shopTotal.toLocaleString();
        }

        function sortShopping() {
            appData.shoppingList.sort((a, b) => {
                if(a.bought !== b.bought) return a.bought ? 1 : -1;
                if(!a.shop) return 1; if(!b.shop) return -1;
                return a.shop.localeCompare(b.shop, "zh-Hant");
            });
            renderShopping();
            save();
            alert('Ë≥ºÁâ©Ê∏ÖÂñÆÂ∑≤ÊéíÂ∫èÔºÅ');
        }

        async function fetchWeather() {
            const day = appData.days[appData.currentDayIdx];
            if(!day.date) { alert('Ë´ãÂÖàË®≠ÂÆöÊó•Êúü'); return; }
            const lat = 35.6895; const lon = 139.6917;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max&timezone=Asia%2FTokyo&start_date=${day.date}&end_date=${day.date}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(data.daily && data.daily.weathercode) {
                    const code = data.daily.weathercode[0];
                    let type = "sunny";
                    if(code >= 1 && code <= 3) type = "cloudy";
                    if(code >= 45 && code <= 48) type = "cloudy";
                    if(code >= 51 && code <= 67) type = "rainy";
                    if(code >= 71 && code <= 77) type = "snow";
                    if(code >= 95) type = "storm";
                    
                    day.weather = type;
                    day.temp = `${data.daily.temperature_2m_max[0]}¬∞`;
                    renderAll();
                    alert(`Â§©Ê∞£Â∑≤Êõ¥Êñ∞ÔºÅ`);
                } else { alert('Êü•ÁÑ°Ê≠§Êó•ÊúüË≥áÊñô (ÂÉÖÈôê14Â§©ÂÖß)'); }
            } catch(e) { alert('ÈÄ£Á∑öÂ§±Êïó'); } 
        }

        function renderBottomBarItinerary() {
            document.getElementById('bottomBar').innerHTML = `
                <button class="action-btn" onclick="addItem()">+ Add Item</button>
                <button class="action-btn" style="background:rgba(255,255,255,0.8); color:#999; border:1px solid #ddd;" onclick="addDay()">+ Day</button>
            `;
        }
        function renderBottomBarShopping() {
            document.getElementById('bottomBar').innerHTML = `
                <button class="action-btn" style="background:var(--shopping-check);" onclick="addShop()">+ Add Product</button>
            `;
        }

        function addItem() { appData.days[appData.currentDayIdx].items.push({id:Date.now(), time:"10:00", category:"other", location:"", cost:0, currency:"JPY", note:""}); renderAll(); }
        function updItem(i, k, v) { appData.days[appData.currentDayIdx].items[i][k] = v; renderAll(); }
        function delItem(i) { if(confirm('Âà™Èô§?')) { appData.days[appData.currentDayIdx].items.splice(i,1); renderAll(); } }
        function addDay() { appData.days.push({date:"", weather:"sunny", temp:"", items:[]}); appData.currentDayIdx = appData.days.length-1; renderAll(); }
        function updateDate() { appData.days[appData.currentDayIdx].date = document.getElementById('dateInput').value; renderAll(); }
        
        function updateWeather() { 
            appData.days[appData.currentDayIdx].weather = document.getElementById('weatherSelect').value; 
            appData.days[appData.currentDayIdx].temp = document.getElementById('tempInput').value; 
            save(); 
            const type = document.getElementById('weatherSelect').value;
            document.getElementById('currentWeatherIcon').innerHTML = svgIcons[type] || svgIcons['sunny'];
        }

        function addShop() { appData.shoppingList.push({id:Date.now(), name:"", shop:"", cost:0, bought:false, note:""}); renderAll(); }
        function toggleShop(i) { appData.shoppingList[i].bought = !appData.shoppingList[i].bought; renderAll(); }
        function updShop(i, k, v) { appData.shoppingList[i][k] = v; renderAll(); }
        function delShop(i) { if(confirm('Âà™Èô§ÂïÜÂìÅ?')) { appData.shoppingList.splice(i,1); renderAll(); } }
        function calcTotal() {
            let jpy = 0; let twd = 0;
            appData.days.forEach(d => d.items.forEach(i => {
                if(i.currency === 'JPY') jpy += Number(i.cost);
                if(i.currency === 'TWD') twd += Number(i.cost);
            }));
            appData.shoppingList.forEach(s => { if(s.bought) jpy += Number(s.cost); });
            document.getElementById('totalJpy').innerText = jpy.toLocaleString();
            document.getElementById('totalTwd').innerText = twd.toLocaleString();
        }
        function openMap(loc) { if(loc) window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(loc), '_blank'); }
        function save() { localStorage.setItem('tokyo_trip_v7', JSON.stringify(appData)); }
    </script>
</body>
</html>
